#include <stdio.h>
#include <stdint.h>

#include "SimplifiedAES.h"


uint8_t S_BOX[] =
{
    0x9, 0x4, 0xA, 0xB,
    0xD, 0x1, 0x8, 0x5,
    0x6, 0x2, 0x0, 0x3,
    0xC, 0xE, 0xF, 0x7
};

uint8_t INVERSE_S_BOX[] =
{
    0xA, 0x5, 0x9, 0xB,
    0x1, 0x7, 0x8, 0xF,
    0x6, 0x0, 0x2, 0x3,
    0xC, 0x4, 0xD, 0xE
};

uint8_t MIXCOLUMN_MATRIX[] =
{
    1, 4,
    4, 1
};

uint8_t INVERSE_MIXCOLUMN_MATRIX[] =
{
    9, 2,
    2, 9
};

uint8_t RC[] = {0x80, 0x30};

uint8_t MUTI_TABLE[16][16] =
{
    {0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
    {0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8, 0x9, 0xA, 0xB, 0xC, 0xD, 0xE, 0xF},
    {0x0, 0x2, 0x4, 0x6, 0x8, 0xA, 0xC, 0xE, 0x3, 0x1, 0x7, 0x5, 0xB, 0x9, 0xF, 0xD},
    {0x0, 0x3, 0x6, 0x5, 0xC, 0xF, 0xA, 0x9, 0xB, 0x8, 0xD, 0xE, 0x7, 0x4, 0x1, 0x2},
    {0x0, 0x4, 0x8, 0xC, 0x3, 0x7, 0xB, 0xF, 0x6, 0x2, 0xE, 0xA, 0x5, 0x1, 0xD, 0x9},
    {0x0, 0x5, 0xA, 0xF, 0x7, 0x2, 0xD, 0x8, 0xE, 0xB, 0x4, 0x1, 0x9, 0xC, 0x3, 0x6},
    {0x0, 0x6, 0xC, 0xA, 0xB, 0xD, 0x7, 0x1, 0x5, 0x3, 0x9, 0xF, 0xE, 0x8, 0x2, 0x4},
    {0x0, 0x7, 0xE, 0x9, 0xF, 0x8, 0x1, 0x6, 0xD, 0xA, 0x3, 0x4, 0x2, 0x5, 0xC, 0xB},
    {0x0, 0x8, 0x3, 0xB, 0x6, 0xE, 0x5, 0xD, 0xC, 0x4, 0xF, 0x7, 0xA, 0x2, 0x9, 0x1},
    {0x0, 0x9, 0x1, 0x8, 0x2, 0xB, 0x3, 0xA, 0x4, 0xD, 0x5, 0xC, 0x6, 0xF, 0x7, 0xE},
    {0x0, 0xA, 0x7, 0xD, 0xE, 0x4, 0x9, 0x3, 0xF, 0x5, 0x8, 0x2, 0x1, 0xB, 0x6, 0xC},
    {0x0, 0xB, 0x5, 0xE, 0xA, 0x1, 0xF, 0x4, 0x7, 0xC, 0x2, 0x9, 0xD, 0x6, 0x8, 0x3},
    {0x0, 0xC, 0xB, 0x7, 0x5, 0x9, 0xE, 0x2, 0xA, 0x6, 0x1, 0xD, 0xF, 0x3, 0x4, 0x8},
    {0x0, 0xD, 0x9, 0x4, 0x1, 0xC, 0x8, 0x5, 0x2, 0xF, 0xB, 0x6, 0x3, 0xE, 0xA, 0x7},
    {0x0, 0xE, 0xF, 0x1, 0xD, 0x3, 0x2, 0xC, 0x9, 0x7, 0x6, 0x8, 0x4, 0xA, 0xB, 0x5},
    {0x0, 0xF, 0xD, 0x2, 0x9, 0x6, 0x4, 0xB, 0x1, 0xE, 0xC, 0x3, 0x8, 0x7, 0x5, 0xA}
};

void ShiftRow(ByteState bs)
{
    bs[1] ^= bs[3];
    bs[3] ^= bs[1];
    bs[1] ^= bs[3];
}

void NibbleSub(ByteState bs, const uint8_t* matrix)
{
    int i;

    for (i = 0; i < 4; i++)
    {
        bs[i] = matrix[bs[i]];
    }
}

void StateExpand(State s, ByteState bs)
{
    int i;

    for (i = 0; i < 2; i++)
    {
        bs[i * 2 + 1] = s[i] >> 4;
        bs[i * 2] = s[i] & 0xF;
    }
}

void StatePack(ByteState bs, State s)
{
    int i;

    for (i = 0; i < 2; i++)
    {
        s[i] = bs[i * 2 + 1] << 4 | bs[i * 2];
    }
}

void AddRoundKey(ByteState bs, Key k)
{
    ByteState ek;
    uint32_t* p1;
    uint32_t* p2;

    p1 = (uint32_t*)bs;
    p2 = (uint32_t*)ek;

    StateExpand(k, ek);
    *p1 ^= *p2;
}

uint8_t g(uint8_t w)
{
    uint8_t ret;
    static uint8_t round =0;

    ret = S_BOX[w >> 4] | S_BOX[w & 0xF] << 4;
    ret ^= RC[round++];

    return ret;
}

void KeyExpand(Key k, ExpandedKey ek)
{
    int i;

    ek[0][0] = k[0];
    ek[0][1] = k[1];

    for (i = 1; i < 3; i++)
    {
        ek[i][0] = ek[i - 1][0] ^ g(ek[i - 1][1]);
        ek[i][1] = ek[i][0] ^ ek[i - 1][1];
    }
}

uint8_t Mutiply(uint8_t a, uint8_t b)
{
    return MUTI_TABLE[a][b];
}

void MixColumn(ByteState bs, const uint8_t* matrix)
{
    int i, j;
    ByteState tmp;
    uint32_t* p1;
    uint32_t* p2;

    tmp[0] = Mutiply(bs[0], matrix[0]) ^ Mutiply(bs[2], matrix[1]);
    tmp[1] = Mutiply(bs[1], matrix[0]) ^ Mutiply(bs[3], matrix[1]);
    tmp[2] = Mutiply(bs[0], matrix[2]) ^ Mutiply(bs[2], matrix[3]);
    tmp[3] = Mutiply(bs[1], matrix[2]) ^ Mutiply(bs[3], matrix[3]);

    p1 = (uint32_t*)tmp;
    p2 = (uint32_t*)bs;
    *p2 = *p1;
}

// Testing
int main(int argc, char* argv[])
{
    State s = {0xCB, 0x6D};
    ByteState bs;
    Key k = {1, 2};
    ExpandedKey ek;
    int i;

    printf("State: %04X\n", *(uint16_t*)s);

    StateExpand(s, bs);
    printf("ByteState: %08X\n", *(uint32_t*)bs);

    MixColumn(bs, MIXCOLUMN_MATRIX);
    printf("MixColumn: %08X\n", *(uint32_t*)bs);

    NibbleSub(bs, S_BOX);
    printf("NibbleSub: %08X\n", *(uint32_t*)bs);

    NibbleSub(bs, INVERSE_S_BOX);
    printf("NibbleSub: %08X\n", *(uint32_t*)bs);

    ShiftRow(bs);
    printf("ShiftRow: %08X\n", *(uint32_t*)bs);

    ShiftRow(bs);
    printf("ShiftRow: %08X\n", *(uint32_t*)bs);

    KeyExpand(k, ek);
    for (i = 0; i < 3; i++)
    {
        printf("Key[%d]: %04X\n", i, *(uint16_t*)ek[i]);
    }

    AddRoundKey(bs, ek[0]);
    printf("AddRoundKey: %08X\n", *(uint32_t*)bs);

    StatePack(bs, s);
    printf("StatePack: %04X\n", *(uint16_t*)s);
}

